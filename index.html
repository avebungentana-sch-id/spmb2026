<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penerimaan Siswa Baru (PPDB)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- jsPDF & QRCode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>

    <style>
        /* Custom Styles for better UX */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .page-view { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast Notification */
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); animation: slideIn 0.3s forwards; }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* Loader */
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col relative">

    <!-- Navbar -->
    <nav class="bg-brand-700 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center cursor-pointer" onclick="navigate('welcome')">
                    <i class="fas fa-graduation-cap text-2xl mr-2"></i>
                    <span class="font-bold text-lg md:text-xl" id="nav-brand">SPMB Online</span>
                </div>
                <div class="flex items-center space-x-4">
                    
                    <!-- Indikator Online/Offline -->
                    <div id="network-status" class="hidden sm:flex items-center text-xs font-medium px-3 py-1.5 rounded-full bg-green-500 text-white shadow-sm transition-all duration-300">
                        <span class="relative flex h-2 w-2 mr-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                        </span>
                        Online
                    </div>

                    <button id="nav-login-btn" onclick="navigate('login')" class="hover:bg-brand-600 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-lock mr-1"></i> Admin
                    </button>
                    <button id="nav-logout-btn" onclick="logout()" class="hidden hover:bg-red-600 bg-red-500 px-3 py-2 rounded-md text-sm font-medium transition">
                        <i class="fas fa-sign-out-alt mr-1"></i> Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-grow w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- ================= PAGE: WELCOME ================= -->
        <div id="page-welcome" class="page-view active">
            
            <!-- Pengumuman Admin -->
            <div id="welcome-announcement" class="hidden bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded-r-xl shadow-sm">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-bullhorn text-yellow-500 mt-1"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-bold text-yellow-800">Pengumuman Panitia</h3>
                        <div class="mt-1 text-sm text-yellow-700 whitespace-pre-line" id="announcement-text">
                            <!-- Text injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden text-center md:text-left md:flex items-center">
                <div class="md:w-1/2 p-8 md:p-12">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4" id="welcome-title">
                        Penerimaan Siswa Baru <span class="text-brand-600">T.A 2026/2027</span>
                    </h1>
                    <p class="text-gray-600 mb-6 text-lg">
                        Bergabunglah bersama kami untuk masa depan yang lebih cerah. Pendaftaran kini lebih mudah, cepat, dan terintegrasi secara online.
                    </p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start">
                        <button onclick="navigate('register')" class="bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                            <i class="fas fa-user-plus mr-2"></i> Daftar Sekarang
                        </button>
                    </div>
                    
                    <div class="mt-8 grid grid-cols-2 gap-4 border-t pt-6">
                        <div class="text-center md:text-left">
                            <p class="text-sm text-gray-500 font-medium">Sisa Kuota</p>
                            <p class="text-2xl font-bold text-brand-600" id="quota-display">Memuat...</p>
                        </div>
                        <div class="text-center md:text-left">
                            <p class="text-sm text-gray-500 font-medium">Batas Pendaftaran</p>
                            <p class="text-lg font-bold text-gray-800" id="welcome-period">30 Juni 2026</p>
                        </div>
                    </div>

                    <!-- Fitur Cek Status -->
                    <div class="mt-8 bg-gray-50 p-5 rounded-xl border border-gray-200 text-left">
                        <h3 class="font-bold text-gray-800 mb-2"><i class="fas fa-search mr-2"></i>Cek Status Pendaftaran</h3>
                        <p class="text-xs text-gray-500 mb-3">Masukkan Nomor Registrasi untuk melihat status pendaftaran Anda.</p>
                        <div class="flex gap-2">
                            <input type="text" id="search-reg-id" placeholder="Cth: REG-2026-001" class="flex-grow px-3 py-2 border rounded outline-none focus:ring-brand-500 text-sm">
                            <button onclick="checkStatus()" class="bg-gray-800 text-white px-4 py-2 rounded font-medium hover:bg-gray-700 transition text-sm">Cari</button>
                        </div>
                        <div id="status-result" class="hidden mt-4 p-4 rounded bg-white border border-gray-200">
                            <!-- Status injected here -->
                        </div>
                    </div>

                </div>
                <div class="md:w-1/2 bg-brand-50 p-8 hidden md:flex justify-center items-center h-full">
                    <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="Students" class="rounded-xl shadow-lg object-cover h-64 w-full">
                </div>
            </div>
        </div>

        <!-- ================= PAGE: REGISTER FORM ================= -->
        <div id="page-register" class="page-view">
            <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Formulir Pendaftaran</h2>
                    <p class="text-sm text-gray-500">Lengkapi data diri Anda di bawah ini dengan benar.</p>
                </div>

                <form id="form-register" onsubmit="handleRegistration(event)">
                    <div class="space-y-4">
                        
                        <!-- Jalur Pendaftaran -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                            <label class="block text-sm font-bold text-brand-700 mb-2"><i class="fas fa-route mr-1"></i> Jalur Pendaftaran</label>
                            <select id="reg-path" required onchange="togglePathInputs()" class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none bg-white transition font-medium text-gray-700">
                                <option value="Reguler">Jalur Reguler</option>
                                <option value="Prestasi">Jalur Prestasi</option>
                                <option value="Afirmasi">Jalur Afirmasi (Keluarga Tidak Mampu)</option>
                            </select>
                        </div>

                        <!-- Dynamic Path Containers -->
                        <div id="path-prestasi-container" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                            <div class="md:col-span-2">
                                <h4 class="text-sm font-bold text-blue-800"><i class="fas fa-trophy mr-1"></i> Data Prestasi Siswa</h4>
                                <p class="text-xs text-blue-600 mt-1">Masukkan data prestasi akademik/non-akademik tertinggi yang dimiliki.</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Tingkat Prestasi</label>
                                <select id="reg-achievement-level" class="w-full px-3 py-2 border border-blue-300 rounded-md outline-none bg-white text-sm">
                                    <option value="">-- Pilih Tingkat --</option>
                                    <option value="Sekolah">Sekolah / Antar Kelas</option>
                                    <option value="Kabupaten/Kota">Kabupaten / Kota</option>
                                    <option value="Provinsi">Provinsi</option>
                                    <option value="Nasional">Nasional</option>
                                    <option value="Internasional">Internasional</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Nama / Jenis Prestasi</label>
                                <input type="text" id="reg-achievement-name" placeholder="Cth: Juara 1 Lomba OSN Matematika..." class="w-full px-3 py-2 border border-blue-300 rounded-md outline-none text-sm">
                            </div>
                        </div>

                        <div id="path-afirmasi-container" class="hidden bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-4">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-yellow-600 mt-0.5 mr-2"></i>
                                <p class="text-sm text-yellow-800 leading-relaxed"><strong>Informasi Jalur Afirmasi:</strong><br>Pendaftar jalur afirmasi <strong>diwajibkan</strong> membawa dan menyerahkan dokumen fisik berupa <strong>Surat Keterangan Tidak Mampu (SKTM)</strong> dari Kelurahan/Desa atau <strong>Kartu KIP/PKH</strong> asli saat melakukan verifikasi berkas pendaftaran ulang di sekolah.</p>
                            </div>
                        </div>

                        <!-- Data Diri Base -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                            <input type="text" id="reg-name" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                                <select id="reg-gender" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none bg-white transition">
                                    <option value="">-- Pilih Jenis Kelamin --</option>
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Agama</label>
                                <select id="reg-religion" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none bg-white transition">
                                    <option value="">-- Pilih Agama --</option>
                                    <option value="Islam">Islam</option>
                                    <option value="Kristen">Kristen</option>
                                    <option value="Katolik">Katolik</option>
                                    <option value="Hindu">Hindu</option>
                                    <option value="Buddha">Buddha</option>
                                    <option value="Konghucu">Konghucu</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NISN</label>
                            <input type="number" id="reg-nisn" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Asal Sekolah</label>
                            <input type="text" id="reg-school" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat SMP Asal</label>
                            <textarea id="reg-school-addr" required rows="2" class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">No. HP / WhatsApp</label>
                            <input type="tel" id="reg-phone" required class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Domisili Siswa</label>
                            <textarea id="reg-address" required rows="2" class="w-full px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none transition"></textarea>
                        </div>
                        
                        <!-- Camera / Photo Input -->
                        <div class="border-t pt-4 mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Foto Diri (Gunakan Kamera / Upload)</label>
                            <p class="text-xs text-gray-500 mb-3">Foto wajib jelas dan menghadap ke depan.</p>
                            
                            <div class="flex flex-col gap-4">
                                <div class="flex flex-wrap gap-2">
                                    <button type="button" onclick="startCamera()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-md hover:bg-blue-200 transition font-medium text-sm flex items-center">
                                        <i class="fas fa-camera mr-2"></i> Buka Kamera
                                    </button>
                                    <label class="cursor-pointer bg-gray-100 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-200 transition font-medium text-sm flex items-center">
                                        <i class="fas fa-upload mr-2"></i> Upload File
                                        <input type="file" id="reg-photo-input" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                                    </label>
                                </div>

                                <!-- Live Camera Container -->
                                <div id="camera-container" class="hidden flex-col items-center gap-3 p-3 bg-gray-50 border rounded-lg">
                                    <video id="camera-video" class="w-full max-w-sm rounded-lg bg-black object-cover" autoplay playsinline></video>
                                    <div class="flex gap-2">
                                        <button type="button" onclick="takeSnapshot()" class="bg-brand-600 text-white px-4 py-2 rounded shadow hover:bg-brand-700 text-sm font-bold">
                                            <i class="fas fa-camera mr-1"></i> Jepret Foto
                                        </button>
                                        <button type="button" onclick="stopCamera()" class="bg-red-100 text-red-600 px-4 py-2 rounded shadow-sm hover:bg-red-200 text-sm">
                                            Batal
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Preview Container -->
                                <div id="photo-preview-container" class="hidden relative w-32 h-32 rounded-lg border overflow-hidden shadow-sm mt-2">
                                    <img id="photo-preview" class="w-full h-full object-cover">
                                    <button type="button" onclick="clearPhoto()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex justify-center items-center text-xs shadow">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <!-- Hidden Canvas for compression -->
                                <canvas id="photo-canvas" class="hidden"></canvas>
                            </div>
                            <input type="hidden" id="reg-photo-base64" required>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-end gap-3">
                        <button type="button" onclick="navigate('welcome')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Batal</button>
                        <button type="submit" class="px-6 py-2 bg-brand-600 text-white rounded-md hover:bg-brand-700 font-bold transition shadow-md">
                            <i class="fas fa-paper-plane mr-1"></i> Submit Pendaftaran
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ================= PAGE: SUCCESS & PRINT ================= -->
        <div id="page-success" class="page-view">
            <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-20 h-20 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Pendaftaran Berhasil!</h2>
                <p class="text-gray-600 mb-6">Terima kasih telah mendaftar. Data Anda telah kami simpan.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6 inline-block text-left">
                    <p class="text-sm text-gray-500">Nomor Pendaftaran:</p>
                    <p class="text-xl font-mono font-bold text-brand-700" id="success-reg-id">REG-...</p>
                    <p class="text-sm text-gray-500 mt-2">Nama:</p>
                    <p class="font-semibold text-gray-800" id="success-name">...</p>
                    <p class="text-sm text-gray-500 mt-2">Jalur:</p>
                    <p class="font-semibold text-gray-800" id="success-path">...</p>
                </div>

                <div class="flex flex-col gap-3">
                    <button onclick="generateRegistrationPDF()" class="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 px-4 rounded-lg shadow transition">
                        <i class="fas fa-print mr-2"></i> Cetak Bukti Pendaftaran (PDF)
                    </button>
                    <button onclick="navigate('welcome')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg transition">
                        Kembali ke Beranda
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= PAGE: LOGIN ADMIN ================= -->
        <div id="page-login" class="page-view">
            <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden p-8 mt-10">
                <div class="text-center mb-8">
                    <div class="inline-block p-3 bg-brand-100 text-brand-600 rounded-full mb-3">
                        <i class="fas fa-user-shield text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">Login Admin</h2>
                    <p class="text-sm text-gray-500">Gunakan admin / admin</p>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fas fa-user"></i></span>
                            <input type="text" id="login-user" required class="w-full pl-10 px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400"><i class="fas fa-lock"></i></span>
                            <input type="password" id="login-pass" required class="w-full pl-10 px-4 py-2 border rounded-md focus:ring-brand-500 focus:border-brand-500 outline-none">
                        </div>
                    </div>
                    <button type="submit" class="w-full py-2 bg-brand-600 text-white rounded-md hover:bg-brand-700 font-bold transition shadow mt-4">
                        Masuk Sistem
                    </button>
                </form>
            </div>
        </div>

        <!-- ================= PAGE: ADMIN DASHBOARD (SIDEBAR TABS) ================= -->
        <div id="page-admin" class="page-view">
            <div class="flex flex-col md:flex-row gap-6">
                
                <!-- Admin Sidebar -->
                <div class="w-full md:w-64 shrink-0 bg-white rounded-xl shadow-md overflow-hidden flex flex-col h-max md:sticky md:top-20 z-10">
                    <div class="p-4 bg-brand-800 text-white flex justify-between items-center md:block">
                        <h3 class="font-bold text-lg hidden md:block"><i class="fas fa-user-shield mr-2"></i>Menu Admin</h3>
                        <span class="md:hidden font-bold">Menu Admin</span>
                        <button class="md:hidden text-white bg-brand-700 px-3 py-1 rounded" onclick="document.getElementById('admin-sidebar-nav').classList.toggle('hidden')">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    <nav id="admin-sidebar-nav" class="hidden md:flex flex-col p-2 space-y-1">
                        <button onclick="switchAdminTab('dashboard')" id="tab-btn-dashboard" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-home w-6 text-center"></i> Dashboard</button>
                        <button onclick="switchAdminTab('pendaftar')" id="tab-btn-pendaftar" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-users w-6 text-center"></i> Data Pendaftar</button>
                        <button onclick="switchAdminTab('pembayaran')" id="tab-btn-pembayaran" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-wallet w-6 text-center"></i> Status Pembayaran</button>
                        <button onclick="switchAdminTab('daftarulang')" id="tab-btn-daftarulang" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-50 transition"><i class="fas fa-user-check w-6 text-center"></i> Daftar Ulang</button>
                        <hr class="my-2 border-gray-200">
                        <button onclick="switchAdminTab('logs')" id="tab-btn-logs" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-indigo-600 hover:bg-indigo-50 transition hidden"><i class="fas fa-history w-6 text-center"></i> Log Aktivitas</button>
                        <button onclick="switchAdminTab('pengaturan')" id="tab-btn-pengaturan" class="admin-tab-btn text-left px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-50 transition hidden"><i class="fas fa-cogs w-6 text-center"></i> Pengaturan</button>
                        <button onclick="openUsersModal()" id="tab-btn-users" class="text-left px-4 py-2 rounded-lg text-indigo-600 hover:bg-indigo-50 transition hidden"><i class="fas fa-user-shield w-6 text-center"></i> Kelola Pengguna</button>
                    </nav>
                </div>

                <!-- Admin Main Content Area -->
                <div class="flex-1 bg-white rounded-xl shadow-md p-4 sm:p-6 overflow-hidden max-w-full min-h-[500px]">
                    
                    <!-- SECTION: DASHBOARD -->
                    <div id="admin-sec-dashboard" class="admin-section hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Statistik</h2>
                        <p class="text-sm text-gray-500 mb-6">Ringkasan data penerimaan siswa baru.</p>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white p-4 rounded-lg border shadow-sm border-l-4 border-brand-500">
                                <p class="text-xs text-gray-500 font-semibold uppercase">Total Pendaftar</p>
                                <p class="text-2xl font-bold" id="stat-total">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border shadow-sm border-l-4 border-green-500">
                                <p class="text-xs text-gray-500 font-semibold uppercase">Pembayaran Lunas</p>
                                <p class="text-2xl font-bold" id="stat-lunas">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border shadow-sm border-l-4 border-yellow-500">
                                <p class="text-xs text-gray-500 font-semibold uppercase">Belum Lunas</p>
                                <p class="text-2xl font-bold" id="stat-belum">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg border shadow-sm border-l-4 border-indigo-500">
                                <p class="text-xs text-gray-500 font-semibold uppercase">Sudah Daftar Ulang</p>
                                <p class="text-2xl font-bold" id="stat-daftarulang">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION: DATA PENDAFTAR -->
                    <div id="admin-sec-pendaftar" class="admin-section hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                            <div>
                                <h2 class="text-xl font-bold text-gray-800">Data Pendaftar</h2>
                                <p class="text-xs text-gray-500">Seluruh data masuk pendaftar PPDB.</p>
                            </div>
                            <div id="bulk-actions" class="flex gap-2">
                                <button onclick="exportCSV()" class="bg-green-600 text-white px-3 py-1.5 text-sm rounded hover:bg-green-700 shadow"><i class="fas fa-file-csv mr-1"></i> Export CSV</button>
                                <button onclick="exportPDFList()" class="bg-red-600 text-white px-3 py-1.5 text-sm rounded hover:bg-red-700 shadow"><i class="fas fa-file-pdf mr-1"></i> Export PDF</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded border">
                            <table class="w-full whitespace-nowrap text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-4 py-3 text-center"><input type="checkbox" id="check-all" onclick="toggleCheckAll()"></th>
                                        <th class="px-6 py-3">No. Reg / Tgl</th>
                                        <th class="px-6 py-3">Data Siswa</th>
                                        <th class="px-6 py-3">Status Seleksi</th>
                                        <th class="px-6 py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pendaftar"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SECTION: PEMBAYARAN -->
                    <div id="admin-sec-pembayaran" class="admin-section hidden">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Status Pembayaran</h2>
                            <p class="text-xs text-gray-500">Kelola validasi & cicilan biaya pendaftaran siswa.</p>
                        </div>
                        <div class="overflow-x-auto rounded border">
                            <table class="w-full whitespace-nowrap text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3">No. Reg</th>
                                        <th class="px-6 py-3">Nama Siswa</th>
                                        <th class="px-6 py-3">Status & Tagihan</th>
                                        <th class="px-6 py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-pembayaran"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SECTION: DAFTAR ULANG -->
                    <div id="admin-sec-daftarulang" class="admin-section hidden">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Daftar Ulang & Seleksi</h2>
                            <p class="text-xs text-gray-500">Tentukan status akhir siswa (Diterima / Ditolak / Sudah Daftar Ulang).</p>
                        </div>
                        <div class="overflow-x-auto rounded border">
                            <table class="w-full whitespace-nowrap text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3">No. Reg</th>
                                        <th class="px-6 py-3">Nama Siswa</th>
                                        <th class="px-6 py-3">Status Daftar Ulang / Seleksi</th>
                                    </tr>
                                </thead>
                                <tbody id="table-daftarulang"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SECTION: LOG AKTIVITAS -->
                    <div id="admin-sec-logs" class="admin-section hidden">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Log Aktivitas (Audit Trail)</h2>
                            <p class="text-xs text-gray-500">Riwayat aksi yang dilakukan oleh Admin dan Sistem.</p>
                        </div>
                        <div class="bg-gray-50 rounded border overflow-hidden">
                            <ul id="log-list" class="divide-y divide-gray-200 max-h-[400px] overflow-y-auto">
                                <!-- Logs injected here -->
                            </ul>
                        </div>
                    </div>

                    <!-- SECTION: PENGATURAN -->
                    <div id="admin-sec-pengaturan" class="admin-section hidden max-w-2xl">
                        <div class="mb-4">
                            <h2 class="text-xl font-bold text-gray-800">Pengaturan PPDB</h2>
                            <p class="text-xs text-gray-500">Konfigurasi dasar sistem dan dokumen.</p>
                        </div>
                        <div class="space-y-4 bg-gray-50 p-6 rounded border">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Nama Sekolah / Instansi</label>
                                <input type="text" id="set-school" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Tahun Ajaran</label>
                                    <input type="text" id="set-year" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Batas Pendaftaran</label>
                                    <input type="text" id="set-period" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Total Kuota Penerimaan</label>
                                    <input type="number" id="set-quota" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Biaya Pendaftaran (Rp)</label>
                                    <input type="number" id="set-fee" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500">
                                    <p class="text-xs text-gray-500 mt-1">Biaya default yang dibebankan ke pendaftar baru.</p>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Pengumuman Halaman Depan</label>
                                <p class="text-xs text-gray-500 mb-2">Tuliskan pesan atau info yang akan tampil di halaman utama pendaftar. Kosongkan jika tidak ada.</p>
                                <textarea id="set-announcement" rows="3" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Dokumen Fisik Wajib (Daftar Ulang)</label>
                                <p class="text-xs text-gray-500 mb-2">Pisahkan dengan koma (,). Contoh: Fotokopi KK, Ijazah Asli</p>
                                <textarea id="set-docs" rows="3" class="w-full px-3 py-2 border rounded outline-none focus:ring-brand-500"></textarea>
                            </div>
                            <div class="pt-4 border-t mt-4">
                                <button onclick="saveSettings()" class="w-full py-3 bg-brand-600 text-white font-bold rounded-lg hover:bg-brand-700 shadow transition">Simpan Pengaturan</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <!-- ================= MODALS ================= -->

    <!-- Modal: Payment Management -->
    <div id="modal-payment" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800"><i class="fas fa-wallet text-brand-600 mr-2"></i>Kelola Pembayaran</h3>
                <button onclick="closeModal('modal-payment')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow" id="payment-modal-content">
                <!-- Data Siswa -->
                <div class="mb-4 bg-blue-50 p-3 rounded border border-blue-100">
                    <p class="text-xs text-blue-800 uppercase font-bold tracking-wider" id="pay-student-id">REG-XXX</p>
                    <p class="font-bold text-lg text-blue-900" id="pay-student-name">Nama Siswa</p>
                </div>

                <!-- Status Pembayaran -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-50 p-3 rounded border">
                        <p class="text-xs text-gray-500">Total Tagihan</p>
                        <p class="font-bold" id="pay-total-fee">Rp 1.100.000</p>
                    </div>
                    <div class="bg-gray-50 p-3 rounded border">
                        <p class="text-xs text-gray-500">Sisa Tagihan</p>
                        <p class="font-bold text-red-600" id="pay-remaining">Rp 0</p>
                    </div>
                    <div class="col-span-2">
                        <p class="text-xs text-gray-500 mb-1">Status:</p>
                        <span id="pay-badge" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200">STATUS</span>
                    </div>
                </div>

                <!-- Riwayat Pembayaran -->
                <div class="mb-6">
                    <h4 class="font-bold text-sm text-gray-700 mb-2 border-b pb-1">Riwayat Cicilan (Maks 4x)</h4>
                    <ul id="pay-history-list" class="space-y-2 text-sm">
                        <!-- History injected here -->
                    </ul>
                </div>

                <!-- Input Pembayaran Baru -->
                <div id="pay-input-section" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Input Pembayaran Baru</label>
                    <div class="flex gap-2">
                        <div class="relative flex-grow">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 font-bold">Rp</span>
                            <input type="number" id="pay-amount-input" placeholder="Nominal..." class="w-full pl-10 px-3 py-2 border rounded outline-none focus:ring-brand-500 focus:border-brand-500">
                        </div>
                        <button onclick="processPayment()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold shadow">
                            Bayar
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle"></i> Sisa kuota cicilan: <span id="pay-installment-left">4</span>x</p>
                </div>
            </div>
            
            <div class="px-6 py-3 border-t bg-gray-50 flex justify-end">
                <button onclick="closeModal('modal-payment')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Student -->
    <div id="modal-edit" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg">Edit Data Pendaftar</h3>
                <button onclick="closeModal('modal-edit')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 space-y-3 overflow-y-auto flex-grow">
                <input type="hidden" id="edit-id">
                <div><label class="block text-xs font-bold text-gray-700">Nama Lengkap</label><input type="text" id="edit-name" class="w-full px-3 py-2 border rounded text-sm"></div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Jalur</label>
                        <select id="edit-path" class="w-full px-3 py-2 border rounded text-sm bg-white font-semibold">
                            <option value="Reguler">Reguler</option>
                            <option value="Prestasi">Prestasi</option>
                            <option value="Afirmasi">Afirmasi</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-700">NISN</label><input type="text" id="edit-nisn" class="w-full px-3 py-2 border rounded text-sm"></div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Jenis Kelamin</label>
                        <select id="edit-gender" class="w-full px-3 py-2 border rounded text-sm bg-white">
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Agama</label>
                        <select id="edit-religion" class="w-full px-3 py-2 border rounded text-sm bg-white">
                            <option value="Islam">Islam</option>
                            <option value="Kristen">Kristen</option>
                            <option value="Katolik">Katolik</option>
                            <option value="Hindu">Hindu</option>
                            <option value="Buddha">Buddha</option>
                            <option value="Konghucu">Konghucu</option>
                        </select>
                    </div>
                </div>
                
                <div><label class="block text-xs font-bold text-gray-700">No. HP</label><input type="text" id="edit-phone" class="w-full px-3 py-2 border rounded text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-700">Alamat Domisili</label><textarea id="edit-address" class="w-full px-3 py-2 border rounded text-sm" rows="2"></textarea></div>
                <div><label class="block text-xs font-bold text-gray-700">Asal Sekolah</label><input type="text" id="edit-school" class="w-full px-3 py-2 border rounded text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-700">Alamat Asal Sekolah</label><textarea id="edit-school-addr" class="w-full px-3 py-2 border rounded text-sm" rows="2"></textarea></div>
                
                <div class="border-t pt-3 mt-2"><label class="block text-xs font-bold text-brand-700 mb-1">Catatan Tambahan Panitia (Dapat Dilihat Pendaftar)</label><textarea id="edit-notes" class="w-full px-3 py-2 border border-brand-200 bg-brand-50 rounded text-sm" rows="2" placeholder="Cth: Dokumen KK menyusul..."></textarea></div>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2">
                <button onclick="closeModal('modal-edit')" class="px-4 py-2 bg-gray-200 rounded text-sm">Batal</button>
                <button onclick="saveEditStudent()" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-bold">Simpan Data</button>
            </div>
        </div>
    </div>

    <!-- Modal: User Management -->
    <div id="modal-users" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-lg"><i class="fas fa-users mr-2 text-gray-600"></i>Kelola Pengguna Sistem</h3>
                <button onclick="closeModal('modal-users')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow space-y-6">
                <!-- Add User Form -->
                <div class="bg-blue-50 p-4 rounded border border-blue-100">
                    <h4 class="text-sm font-bold mb-3 text-blue-900">Tambah Akun Baru</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <input type="text" id="new-user-name" placeholder="Username" class="px-3 py-2 border rounded text-sm outline-none">
                        <input type="password" id="new-user-pass" placeholder="Password" class="px-3 py-2 border rounded text-sm outline-none">
                    </div>
                    <div class="flex gap-3">
                        <select id="new-user-role" class="px-3 py-2 border rounded text-sm outline-none flex-grow">
                            <option value="admin">Admin (Akses Penuh)</option>
                            <option value="kepsek">Kepala Sekolah (Hanya Pantau/Ekspor)</option>
                        </select>
                        <button onclick="addUser()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow">Tambah</button>
                    </div>
                </div>

                <!-- User List -->
                <div>
                    <h4 class="text-sm font-bold mb-3 text-gray-800">Daftar Akun Terdaftar</h4>
                    <ul id="user-list" class="space-y-2 text-sm">
                        <!-- Users injected here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        /**
         * HYBRID ARCHITECTURE PREPARATION (Offline / Online ready)
         */
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key)) || null,
            set: (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
                // Trigger sinkronisasi ke Firebase secara background
                if(typeof window.firebaseSync === 'function') {
                    window.firebaseSync(key, data);
                }
            },
            
            // App specific
            getStudents: () => DB.get('ppdb_students') || [],
            saveStudents: (data) => DB.set('ppdb_students', data),
            
            getSettings: () => {
                let s = DB.get('ppdb_settings');
                return s ? s : { 
                    schoolName: 'SMA Negeri 1 Contoh',
                    academicYear: '2026/2027',
                    period: '30 Juni 2026',
                    quota: 150, 
                    baseFee: 1100000,
                    announcement: '', 
                    documents: ['Fotokopi KK', 'Fotokopi Akta Kelahiran', 'Ijazah/SKL', 'Pas Foto 3x4 (2 lembar)'] 
                };
            },
            saveSettings: (data) => DB.set('ppdb_settings', data),

            getUsers: () => {
                let u = DB.get('ppdb_users');
                return u ? u : [{ username: 'admin', password: 'admin', role: 'admin' }];
            },
            saveUsers: (data) => DB.set('ppdb_users', data),

            getLogs: () => DB.get('ppdb_logs') || [],
            saveLogs: (data) => DB.set('ppdb_logs', data)
        };

        // Constants & Global State
        let currentStudentForPayment = null;
        let loggedInUser = JSON.parse(sessionStorage.getItem('ppdb_user')) || null;
        let isAdminLoggedIn = !!loggedInUser;

        // ================= UTILS =================
        const formatRp = (num) => "Rp " + num.toLocaleString('id-ID');
        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i> ${msg}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        // ================= NETWORK & FIREBASE STATUS =================
        function updateNetworkStatus() {
            const statusEl = document.getElementById('network-status');
            if(!statusEl) return;
            
            if (navigator.onLine) {
                statusEl.className = "hidden sm:flex items-center text-xs font-medium px-3 py-1.5 rounded-full bg-green-500 text-white shadow-sm transition-all duration-300";
                statusEl.innerHTML = `<span class="relative flex h-2 w-2 mr-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span></span>Online`;
                
                // Tarik data terbaru & dorong data lokal saat internet kembali terhubung
                if(typeof window.firebasePull === 'function') window.firebasePull();
                if(typeof window.firebaseSync === 'function') {
                    ['ppdb_students', 'ppdb_settings', 'ppdb_users', 'ppdb_logs'].forEach(key => {
                        const data = DB.get(key);
                        if(data) window.firebaseSync(key, data);
                    });
                }
            } else {
                statusEl.className = "hidden sm:flex items-center text-xs font-medium px-3 py-1.5 rounded-full bg-red-500 text-white shadow-sm transition-all duration-300";
                statusEl.innerHTML = `<i class="fas fa-wifi-slash mr-2 text-[10px]"></i>Offline Mode`;
                showToast("Koneksi terputus. Data akan disimpan di perangkat (Local Storage).", "error");
            }
        }

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);

        // ================= ACTIVITY LOGGING (AUDIT TRAIL) =================
        function addLog(actionDetails) {
            const logs = DB.getLogs();
            const username = loggedInUser ? loggedInUser.username : 'Sistem / Guest';
            
            logs.unshift({ // Add to beginning
                date: new Date().toISOString(),
                user: username,
                action: actionDetails
            });
            
            // Keep only the last 150 logs to prevent storage bloat
            if(logs.length > 150) logs.pop();
            
            DB.saveLogs(logs);
        }

        function renderLogs() {
            const logs = DB.getLogs();
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            
            if(logs.length === 0) {
                list.innerHTML = '<li class="p-4 text-center text-sm text-gray-500">Belum ada aktivitas terekam.</li>';
                return;
            }

            logs.forEach(log => {
                list.innerHTML += `
                    <li class="p-3 hover:bg-gray-100 flex items-start gap-3">
                        <div class="mt-1 bg-gray-200 text-gray-500 rounded-full w-8 h-8 flex items-center justify-center shrink-0">
                            <i class="fas fa-history text-xs"></i>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">${log.action}</p>
                            <p class="text-xs text-gray-500 mt-0.5">Oleh: <span class="font-bold text-gray-700">${log.user}</span> &bull; ${formatDate(log.date)}</p>
                        </div>
                    </li>
                `;
            });
        }

        // ================= NAVIGATION =================
        function navigate(pageId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageId}`).classList.add('active');
            window.scrollTo(0,0);

            if(pageId === 'welcome') updateQuotaDisplay();
            if(pageId === 'admin') {
                if(!isAdminLoggedIn) { showToast("Silahkan login", "error"); navigate('login'); return; }
                
                // Role-based UI updates for Sidebar
                const btnSettings = document.getElementById('tab-btn-pengaturan');
                const btnManageUsers = document.getElementById('tab-btn-users');
                const btnLogs = document.getElementById('tab-btn-logs');
                if(loggedInUser && loggedInUser.role === 'admin') {
                    if(btnSettings) btnSettings.classList.remove('hidden');
                    if(btnManageUsers) btnManageUsers.classList.remove('hidden');
                    if(btnLogs) btnLogs.classList.remove('hidden');
                } else {
                    if(btnSettings) btnSettings.classList.add('hidden');
                    if(btnManageUsers) btnManageUsers.classList.add('hidden');
                    if(btnLogs) btnLogs.classList.add('hidden');
                }
                
                // Automatically open dashboard tab
                switchAdminTab('dashboard');
            }
        }

        function updateAppInfo() {
            const set = DB.getSettings();
            document.getElementById('nav-brand').innerText = `SPMB ${set.schoolName}`;
            document.getElementById('welcome-title').innerHTML = `Penerimaan Siswa Baru <span class="text-brand-600">T.A ${set.academicYear}</span>`;
            document.getElementById('welcome-period').innerText = set.period;
            
            // Render Announcement
            const annContainer = document.getElementById('welcome-announcement');
            if(set.announcement && set.announcement.trim() !== '') {
                document.getElementById('announcement-text').innerText = set.announcement;
                annContainer.classList.remove('hidden');
            } else {
                annContainer.classList.add('hidden');
            }
        }

        // ================= FITUR CEK STATUS =================
        function checkStatus() {
            const regId = document.getElementById('search-reg-id').value.trim();
            const resultBox = document.getElementById('status-result');
            
            if(!regId) {
                showToast("Silakan masukkan Nomor Registrasi", "error");
                return;
            }

            const student = DB.getStudents().find(s => s.id.toLowerCase() === regId.toLowerCase());
            resultBox.classList.remove('hidden');

            if(student) {
                let badgeClass = 'bg-gray-100 text-gray-800 border-gray-200';
                const s = student.admissionStatus || 'Menunggu';
                if(s === 'Diterima') badgeClass = 'bg-blue-100 text-blue-800 border-blue-200';
                else if(s === 'Ditolak') badgeClass = 'bg-red-100 text-red-800 border-red-200';
                else if(s === 'Sudah Daftar Ulang') badgeClass = 'bg-green-100 text-green-800 border-green-200';

                let notesHtml = student.notes ? `<div class="mt-3 p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200 text-sm"><i class="fas fa-info-circle mr-1"></i> <strong>Catatan Panitia:</strong><br>${student.notes}</div>` : '';

                resultBox.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="text-sm text-gray-500">Hasil Pencarian untuk: <strong class="text-gray-800">${student.id}</strong></div>
                        <div class="font-bold text-lg text-brand-700">${student.name}</div>
                        <div class="mt-1 flex gap-2 items-center">
                            <span class="px-3 py-1 text-sm font-bold rounded border ${badgeClass}">${s}</span>
                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-semibold border border-purple-200">Jalur: ${student.path || 'Reguler'}</span>
                        </div>
                        ${notesHtml}
                    </div>
                `;
            } else {
                resultBox.innerHTML = `
                    <div class="text-red-500 text-sm flex items-center">
                        <i class="fas fa-times-circle text-xl mr-2"></i> Data Pendaftaran tidak ditemukan. Pastikan nomor sudah benar.
                    </div>
                `;
            }
        }

        // ================= REGISTRATION PATH & CAMERA =================
        function togglePathInputs() {
            const path = document.getElementById('reg-path').value;
            const presCont = document.getElementById('path-prestasi-container');
            const afirCont = document.getElementById('path-afirmasi-container');
            
            presCont.classList.add('hidden');
            afirCont.classList.add('hidden');
            
            if(path === 'Prestasi') presCont.classList.remove('hidden');
            if(path === 'Afirmasi') afirCont.classList.remove('hidden');
        }

        let videoStream = null;

        async function startCamera() {
            const video = document.getElementById('camera-video');
            const container = document.getElementById('camera-container');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
                videoStream = stream;
                container.classList.remove('hidden');
                container.classList.add('flex');
            } catch (err) {
                console.error("Camera access denied or unavailable: ", err);
                showToast("Kamera tidak dapat diakses. Silakan gunakan fitur Upload File.", "error");
            }
        }

        function takeSnapshot() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('photo-canvas');
            const ctx = canvas.getContext('2d');
            
            if(!videoStream) return;

            const MAX_SIZE = 600;
            let width = video.videoWidth;
            let height = video.videoHeight;
            if (width > height && width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } 
            else if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.drawImage(video, 0, 0, width, height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('reg-photo-base64').value = dataUrl;
            document.getElementById('photo-preview').src = dataUrl;
            document.getElementById('photo-preview-container').classList.remove('hidden');
            
            stopCamera(); 
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('camera-video').srcObject = null;
            document.getElementById('camera-container').classList.add('hidden');
            document.getElementById('camera-container').classList.remove('flex');
        }

        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('photo-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const MAX_SIZE = 600;
                    let width = img.width;
                    let height = img.height;
                    if (width > height && width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } 
                    else if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                    document.getElementById('reg-photo-base64').value = dataUrl;
                    document.getElementById('photo-preview').src = dataUrl;
                    document.getElementById('photo-preview-container').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearPhoto() {
            document.getElementById('reg-photo-input').value = '';
            document.getElementById('reg-photo-base64').value = '';
            document.getElementById('photo-preview-container').classList.add('hidden');
        }

        // ================= REGISTRATION LOGIC =================
        function generateRegID() {
            const students = DB.getStudents();
            const year = new Date().getFullYear();
            const count = students.length + 1;
            return `REG-${year}-${count.toString().padStart(3, '0')}`;
        }

        function handleRegistration(e) {
            e.preventDefault();
            const photo = document.getElementById('reg-photo-base64').value;
            if(!photo) { showToast("Mohon lampirkan foto diri!", "error"); return; }

            const baseFee = DB.getSettings().baseFee || 1100000;
            const path = document.getElementById('reg-path').value;
            
            let achievementInfo = null;
            if(path === 'Prestasi') {
                const lvl = document.getElementById('reg-achievement-level').value;
                const nm = document.getElementById('reg-achievement-name').value.trim();
                if(lvl || nm) achievementInfo = `${lvl} - ${nm}`;
            }

            const newStudent = {
                id: generateRegID(),
                timestamp: new Date().toISOString(),
                path: path,
                achievementInfo: achievementInfo,
                name: document.getElementById('reg-name').value.trim(),
                gender: document.getElementById('reg-gender').value,
                religion: document.getElementById('reg-religion').value,
                nisn: document.getElementById('reg-nisn').value.trim(),
                school: document.getElementById('reg-school').value.trim(),
                schoolAddress: document.getElementById('reg-school-addr').value.trim(),
                phone: document.getElementById('reg-phone').value.trim(),
                address: document.getElementById('reg-address').value.trim(),
                photo: photo,
                notes: '', 
                admissionStatus: 'Menunggu',
                payments: {
                    totalFee: baseFee, 
                    remaining: baseFee,
                    status: 'BELUM LUNAS',
                    history: []
                }
            };

            const students = DB.getStudents();
            students.push(newStudent);
            DB.saveStudents(students);
            addLog(`Pendaftaran siswa baru masuk: ${newStudent.name} (${newStudent.id}) via Jalur ${path}`);

            // Cleanup
            document.getElementById('form-register').reset();
            clearPhoto();
            stopCamera();
            togglePathInputs();

            document.getElementById('success-reg-id').innerText = newStudent.id;
            document.getElementById('success-name').innerText = newStudent.name;
            document.getElementById('success-path').innerText = path;
            window.lastRegisteredId = newStudent.id; 
            
            showToast("Pendaftaran Berhasil!");
            navigate('success');
        }

        // ================= ADMIN AUTH & USERS =================
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            
            const users = DB.getUsers();
            const validUser = users.find(user => user.username === u && user.password === p);

            if(validUser) {
                loggedInUser = { username: validUser.username, role: validUser.role };
                isAdminLoggedIn = true;
                sessionStorage.setItem('ppdb_user', JSON.stringify(loggedInUser));
                
                document.getElementById('nav-login-btn').classList.add('hidden');
                document.getElementById('nav-logout-btn').classList.remove('hidden');
                
                addLog(`Login ke sistem sebagai ${validUser.role}`);
                
                showToast(`Login sukses sebagai ${validUser.role.toUpperCase()}`);
                navigate('admin');
            } else {
                showToast("Username / Password salah!", "error");
            }
        }

        function logout() {
            if(loggedInUser) addLog("Logout dari sistem");
            isAdminLoggedIn = false;
            loggedInUser = null;
            sessionStorage.removeItem('ppdb_user');
            document.getElementById('nav-login-btn').classList.remove('hidden');
            document.getElementById('nav-logout-btn').classList.add('hidden');
            navigate('welcome');
        }

        if(isAdminLoggedIn) {
            document.getElementById('nav-login-btn').classList.add('hidden');
            document.getElementById('nav-logout-btn').classList.remove('hidden');
        }

        function openUsersModal() {
            renderUsers();
            document.getElementById('modal-users').classList.remove('hidden');
        }

        function renderUsers() {
            const users = DB.getUsers();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            users.forEach(u => {
                const delBtn = u.username === 'admin' ? '' : `<button onclick="deleteUser('${u.username}')" class="text-red-500 hover:text-red-700 bg-red-50 p-1 rounded"><i class="fas fa-trash"></i></button>`;
                list.innerHTML += `
                    <li class="flex justify-between items-center p-3 border rounded bg-white shadow-sm">
                        <div>
                            <span class="font-bold text-gray-800 mr-2"><i class="fas fa-user-circle mr-1"></i>${u.username}</span> 
                            <span class="text-xs text-white px-2 py-0.5 ${u.role === 'admin' ? 'bg-indigo-600' : 'bg-gray-600'} rounded-full">${u.role.toUpperCase()}</span>
                        </div>
                        ${delBtn}
                    </li>
                `;
            });
        }

        function addUser() {
            const u = document.getElementById('new-user-name').value.trim();
            const p = document.getElementById('new-user-pass').value;
            const r = document.getElementById('new-user-role').value;
            if(!u || !p) return showToast("Isi Username dan Password", "error");
            
            let users = DB.getUsers();
            if(users.find(x => x.username === u)) return showToast("Username sudah digunakan", "error");
            
            users.push({ username: u, password: p, role: r });
            DB.saveUsers(users);
            addLog(`Menambahkan pengguna baru: ${u} (${r})`);
            
            showToast("Pengguna ditambahkan");
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-pass').value = '';
            renderUsers();
        }

        function deleteUser(username) {
            if(username === 'admin') return;
            if(!confirm(`Yakin ingin menghapus akses untuk ${username}?`)) return;
            let users = DB.getUsers();
            users = users.filter(u => u.username !== username);
            DB.saveUsers(users);
            addLog(`Menghapus pengguna: ${username}`);
            renderUsers();
        }

        // ================= ADMIN DASHBOARD (SIDEBAR & TAB RENDERING) =================
        
        function switchAdminTab(tabId) {
            document.querySelectorAll('.admin-section').forEach(el => el.classList.add('hidden'));
            
            document.querySelectorAll('.admin-tab-btn').forEach(el => {
                el.classList.remove('bg-brand-50', 'text-brand-700', 'font-bold');
                el.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            
            const activeSec = document.getElementById(`admin-sec-${tabId}`);
            if(activeSec) activeSec.classList.remove('hidden');
            
            const activeBtn = document.getElementById(`tab-btn-${tabId}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-brand-50', 'text-brand-700', 'font-bold');
                activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-50');
            }

            if(tabId === 'pengaturan') {
                const set = DB.getSettings();
                document.getElementById('set-school').value = set.schoolName || '';
                document.getElementById('set-year').value = set.academicYear || '';
                document.getElementById('set-period').value = set.period || '';
                document.getElementById('set-quota').value = set.quota;
                document.getElementById('set-fee').value = set.baseFee || 1100000;
                document.getElementById('set-announcement').value = set.announcement || '';
                document.getElementById('set-docs').value = set.documents.join(', ');
            } else if (tabId === 'logs') {
                renderLogs();
            } else {
                renderAdminTable();
            }

            if(window.innerWidth < 768) {
                document.getElementById('admin-sidebar-nav').classList.add('hidden');
            }
        }

        function updateQuotaDisplay() {
            const students = DB.getStudents();
            const settings = DB.getSettings();
            const sisa = settings.quota - students.length;
            document.getElementById('quota-display').innerText = sisa > 0 ? sisa + " Kursi" : "Penuh";
        }

        function renderAdminTable() {
            const students = DB.getStudents().reverse(); 
            const isAdmin = loggedInUser && loggedInUser.role === 'admin';
            
            const checkAll = document.getElementById('check-all');
            if(checkAll) checkAll.checked = false;

            document.getElementById('stat-total').innerText = students.length;
            document.getElementById('stat-lunas').innerText = students.filter(s => s.payments.status === 'LUNAS').length;
            document.getElementById('stat-belum').innerText = students.filter(s => s.payments.status !== 'LUNAS').length;
            document.getElementById('stat-daftarulang').innerText = students.filter(s => s.admissionStatus === 'Sudah Daftar Ulang').length;

            const tbPendaftar = document.getElementById('table-pendaftar');
            const tbPembayaran = document.getElementById('table-pembayaran');
            const tbDaftarulang = document.getElementById('table-daftarulang');

            tbPendaftar.innerHTML = '';
            tbPembayaran.innerHTML = '';
            tbDaftarulang.innerHTML = '';

            if(students.length === 0) {
                tbPendaftar.innerHTML = `<tr><td colspan="5" class="text-center py-6 text-gray-500">Belum ada data pendaftar.</td></tr>`;
                tbPembayaran.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-gray-500">Belum ada tagihan pembayaran.</td></tr>`;
                tbDaftarulang.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-gray-500">Belum ada data seleksi.</td></tr>`;
                return;
            }

            students.forEach(s => {
                let payBadgeColor = s.payments.status === 'LUNAS' ? 'bg-green-100 text-green-800 border-green-200' : 'bg-yellow-100 text-yellow-800 border-yellow-200';
                let admStatus = s.admissionStatus || 'Menunggu';
                
                let admBadgeColor = 'bg-gray-100 text-gray-800 border-gray-200';
                if(admStatus === 'Diterima') admBadgeColor = 'bg-blue-100 text-blue-800 border-blue-200';
                else if(admStatus === 'Ditolak') admBadgeColor = 'bg-red-100 text-red-800 border-red-200';
                else if(admStatus === 'Sudah Daftar Ulang') admBadgeColor = 'bg-green-100 text-green-800 border-green-200';
                
                // Indikator Jalur Pendaftaran
                let pathStr = s.path || 'Reguler';
                let pathBadgeColor = 'bg-purple-100 text-purple-800 border-purple-200';
                if(pathStr === 'Prestasi') pathBadgeColor = 'bg-orange-100 text-orange-800 border-orange-200';
                if(pathStr === 'Afirmasi') pathBadgeColor = 'bg-pink-100 text-pink-800 border-pink-200';
                let achievementSubtext = (pathStr === 'Prestasi' && s.achievementInfo) ? `<br><span class="text-[10px] text-orange-600 block leading-tight mt-0.5"><i class="fas fa-trophy"></i> ${s.achievementInfo}</span>` : '';

                let actionHtml = '';
                if(isAdmin) {
                    actionHtml = `
                        <button onclick="openEditModal('${s.id}')" title="Edit Data" class="bg-gray-100 text-gray-600 hover:bg-gray-200 p-2 rounded shadow-sm"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteStudent('${s.id}')" title="Hapus" class="bg-red-100 text-red-600 hover:bg-red-200 p-2 rounded shadow-sm"><i class="fas fa-trash"></i></button>
                    `;
                }

                // 1. Table Pendaftar
                let trPendaftar = document.createElement('tr');
                trPendaftar.className = "border-b hover:bg-gray-50";
                trPendaftar.innerHTML = `
                    <td class="px-4 py-4 text-center"><input type="checkbox" class="row-check" value="${s.id}"></td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">${s.id}</div>
                        <div class="text-xs text-gray-400 mb-1">${formatDate(s.timestamp)}</div>
                        <span class="px-2 py-0.5 text-[10px] font-bold rounded border uppercase ${pathBadgeColor}">${pathStr}</span>
                    </td>
                    <td class="px-6 py-4 flex items-start gap-3">
                        <img src="${s.photo}" class="h-10 w-10 rounded-full object-cover border mt-1" alt="Foto">
                        <div>
                            <div class="font-semibold text-gray-700">${s.name}</div>
                            <div class="text-[11px] text-gray-500">NISN: ${s.nisn} | HP: ${s.phone}</div>
                            ${achievementSubtext}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded border ${admBadgeColor}">${admStatus}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="generateRegistrationPDF('${s.id}')" title="Cetak Bukti Registrasi" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-2 rounded shadow-sm"><i class="fas fa-print"></i></button>
                            ${actionHtml}
                        </div>
                    </td>
                `;
                tbPendaftar.appendChild(trPendaftar);

                // 2. Table Pembayaran
                let trPembayaran = document.createElement('tr');
                trPembayaran.className = "border-b hover:bg-gray-50";
                trPembayaran.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-800">${s.id}</td>
                    <td class="px-6 py-4 font-semibold text-gray-700">${s.name}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-semibold rounded border ${payBadgeColor}">${s.payments.status}</span>
                        <div class="text-xs mt-1 text-gray-500">Sisa Tagihan: ${formatRp(s.payments.remaining)}</div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        ${isAdmin ? `<button onclick="openPaymentModal('${s.id}')" class="bg-blue-600 text-white hover:bg-blue-700 px-3 py-1.5 text-sm rounded shadow"><i class="fas fa-wallet mr-1"></i> Kelola Pembayaran</button>` : '-'}
                    </td>
                `;
                tbPembayaran.appendChild(trPembayaran);

                // 3. Table Daftar Ulang & Seleksi
                let selectDisabled = !isAdmin ? 'disabled' : '';
                let trDaftarulang = document.createElement('tr');
                trDaftarulang.className = "border-b hover:bg-gray-50";
                trDaftarulang.innerHTML = `
                    <td class="px-6 py-4 font-bold text-gray-800">${s.id}</td>
                    <td class="px-6 py-4">
                        <div class="font-semibold text-gray-700">${s.name} <span class="text-[10px] text-gray-400 uppercase border rounded px-1 ml-1">${pathStr}</span></div>
                        <div class="text-xs text-gray-500 mt-0.5">Asal Sekolah: ${s.school}</div>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="changeAdmissionStatus('${s.id}', this.value)" class="border border-gray-300 rounded-md px-3 py-1.5 bg-white text-sm focus:outline-none focus:border-brand-500 font-semibold text-gray-700" ${selectDisabled}>
                            <option value="Menunggu" ${admStatus === 'Menunggu' ? 'selected' : ''}> Menunggu</option>
                            <option value="Diterima" ${admStatus === 'Diterima' ? 'selected' : ''}> Diterima</option>
                            <option value="Ditolak" ${admStatus === 'Ditolak' ? 'selected' : ''}> Ditolak</option>
                            <option value="Sudah Daftar Ulang" ${admStatus === 'Sudah Daftar Ulang' ? 'selected' : ''}> Sudah Daftar Ulang</option>
                        </select>
                    </td>
                `;
                tbDaftarulang.appendChild(trDaftarulang);
            });
        }

        // = Checkbox & Export Logic
        function toggleCheckAll() {
            const checkAll = document.getElementById('check-all');
            const checks = document.querySelectorAll('.row-check');
            checks.forEach(c => c.checked = checkAll.checked);
        }

        function getSelectedIds() {
            const checks = document.querySelectorAll('.row-check:checked');
            return Array.from(checks).map(c => c.value);
        }

        function exportCSV() {
            const selected = getSelectedIds();
            if(!selected.length) return showToast("Centang data pendaftar pada tabel terlebih dahulu", "error");
            
            const students = DB.getStudents().filter(s => selected.includes(s.id));
            let csv = "No Reg,Waktu Daftar,Jalur,Nama Lengkap,Jenis Kelamin,Agama,NISN,Asal Sekolah,Alamat Sekolah,No HP,Alamat Domisili,Status Seleksi,Catatan Panitia\n";
            students.forEach(s => {
                let noteClean = (s.notes || '').replace(/(\r\n|\n|\r)/gm, " "); 
                let pathStr = s.path || 'Reguler';
                if(s.achievementInfo) pathStr += ` (${s.achievementInfo})`;
                csv += `"${s.id}","${formatDate(s.timestamp)}","${pathStr}","${s.name}","${s.gender || '-'}","${s.religion || '-'}","${s.nisn}","${s.school}","${s.schoolAddress || '-'}","${s.phone}","${s.address || '-'}","${s.admissionStatus || 'Menunggu'}","${noteClean}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Data_Pendaftar_PPDB.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            addLog(`Mengekspor ${students.length} data pendaftar dalam format CSV`);
        }

        function exportPDFList() {
            const selected = getSelectedIds();
            if(!selected.length) return showToast("Centang data pendaftar pada tabel terlebih dahulu", "error");
            
            const students = DB.getStudents().filter(s => selected.includes(s.id));
            const set = DB.getSettings();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape'); 

            doc.setFontSize(14);
            doc.text(`Data Pendaftar SPMB - ${set.schoolName}`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Tahun Ajaran ${set.academicYear}`, 14, 21);

            const tableData = students.map((s, i) => [
                i + 1, s.id, s.path || 'Reguler', s.name, (s.gender||'-').substring(0,1), s.nisn, s.school, s.phone, s.admissionStatus || 'Menunggu'
            ]);

            doc.autoTable({
                startY: 28,
                head: [['No', 'No Reg', 'Jalur', 'Nama Lengkap', 'L/P', 'NISN', 'Sekolah', 'No HP', 'Status']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [37, 99, 235] },
                styles: { fontSize: 8 }
            });

            doc.save(`Tabel_Data_Pendaftar_PPDB.pdf`);
            addLog(`Mengekspor ${students.length} data pendaftar dalam format PDF List`);
        }

        // = CRUD Operations & Actions
        function changeAdmissionStatus(id, newStatus) {
            let students = DB.getStudents();
            let student = students.find(s => s.id === id);
            if(student) {
                student.admissionStatus = newStatus;
                DB.saveStudents(students);
                addLog(`Merubah status seleksi [${student.id}] ${student.name} menjadi: ${newStatus}`);
                showToast("Status seleksi diperbarui menjadi: " + newStatus);
                renderAdminTable(); 
            }
        }

        function deleteStudent(id) {
            if(confirm('Yakin ingin menghapus data siswa ini?')) {
                let students = DB.getStudents();
                let studentName = students.find(s => s.id === id)?.name || id;
                students = students.filter(s => s.id !== id);
                DB.saveStudents(students);
                
                addLog(`Menghapus permanen data pendaftar: [${id}] ${studentName}`);
                showToast("Data dihapus!");
                renderAdminTable();
            }
        }

        function openEditModal(id) {
            const student = DB.getStudents().find(s => s.id === id);
            if(!student) return;
            document.getElementById('edit-id').value = student.id;
            document.getElementById('edit-name').value = student.name;
            document.getElementById('edit-path').value = student.path || 'Reguler';
            document.getElementById('edit-gender').value = student.gender || 'Laki-laki';
            document.getElementById('edit-religion').value = student.religion || 'Islam';
            document.getElementById('edit-nisn').value = student.nisn;
            document.getElementById('edit-school').value = student.school;
            document.getElementById('edit-school-addr').value = student.schoolAddress || '';
            document.getElementById('edit-phone').value = student.phone;
            document.getElementById('edit-address').value = student.address || '';
            document.getElementById('edit-notes').value = student.notes || '';
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        function saveEditStudent() {
            const id = document.getElementById('edit-id').value;
            let students = DB.getStudents();
            let idx = students.findIndex(s => s.id === id);
            if(idx > -1) {
                students[idx].name = document.getElementById('edit-name').value;
                students[idx].path = document.getElementById('edit-path').value;
                students[idx].gender = document.getElementById('edit-gender').value;
                students[idx].religion = document.getElementById('edit-religion').value;
                students[idx].nisn = document.getElementById('edit-nisn').value;
                students[idx].school = document.getElementById('edit-school').value;
                students[idx].schoolAddress = document.getElementById('edit-school-addr').value;
                students[idx].phone = document.getElementById('edit-phone').value;
                students[idx].address = document.getElementById('edit-address').value;
                students[idx].notes = document.getElementById('edit-notes').value;
                
                DB.saveStudents(students);
                addLog(`Mengedit detail profil data pendaftar: [${id}] ${students[idx].name}`);
                
                closeModal('modal-edit');
                showToast("Data diperbarui");
                renderAdminTable();
            }
        }

        // = Settings Configuration Save Logic
        function saveSettings() {
            const schoolName = document.getElementById('set-school').value || 'Sekolah';
            const academicYear = document.getElementById('set-year').value || '2026/2027';
            const period = document.getElementById('set-period').value || '-';
            const quota = parseInt(document.getElementById('set-quota').value) || 150;
            const baseFee = parseInt(document.getElementById('set-fee').value) || 1100000;
            const announcement = document.getElementById('set-announcement').value || '';
            const docsRaw = document.getElementById('set-docs').value;
            const docs = docsRaw.split(',').map(d => d.trim()).filter(d => d !== '');
            
            DB.saveSettings({ schoolName, academicYear, period, quota, baseFee, announcement, documents: docs });
            addLog(`Memperbarui pengaturan sistem dasar`);
            
            updateAppInfo();
            showToast("Pengaturan berhasil disimpan");
        }

        function closeModal(modalId) { 
            document.getElementById(modalId).classList.add('hidden'); 
            if(modalId === 'modal-payment') { /* any payment cleanup */ }
        }

        // ================= PAYMENT LOGIC =================
        function openPaymentModal(id) {
            currentStudentForPayment = id;
            const student = DB.getStudents().find(s => s.id === id);
            if(!student) return;

            document.getElementById('pay-student-id').innerText = student.id;
            document.getElementById('pay-student-name').innerText = student.name;
            document.getElementById('pay-total-fee').innerText = formatRp(student.payments.totalFee);
            document.getElementById('pay-remaining').innerText = formatRp(student.payments.remaining);
            
            const badge = document.getElementById('pay-badge');
            badge.innerText = student.payments.status;
            badge.className = student.payments.status === 'LUNAS' 
                ? 'px-3 py-1 rounded-full text-xs font-bold bg-green-200 text-green-800' 
                : 'px-3 py-1 rounded-full text-xs font-bold bg-red-200 text-red-800';

            // Render History
            const histList = document.getElementById('pay-history-list');
            histList.innerHTML = '';
            
            student.payments.history.forEach((h, index) => {
                let li = document.createElement('li');
                li.className = "flex justify-between items-center bg-white p-2 border rounded";
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">Cicilan #${h.installmentNum}</p>
                        <p class="text-xs text-gray-500">${formatDate(h.date)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">+ ${formatRp(h.amount)}</p>
                        <button onclick="printReceipt('${student.id}', ${index})" class="text-xs text-blue-600 hover:underline"><i class="fas fa-print"></i> Cetak</button>
                    </div>
                `;
                histList.appendChild(li);
            });

            if(student.payments.history.length === 0) {
                histList.innerHTML = '<li class="text-gray-400 text-xs italic">Belum ada riwayat pembayaran.</li>';
            }

            // Input Logic
            const inputSec = document.getElementById('pay-input-section');
            const inputEl = document.getElementById('pay-amount-input');
            const instLeft = 4 - student.payments.history.length;
            document.getElementById('pay-installment-left').innerText = instLeft;

            if(student.payments.remaining <= 0 || instLeft <= 0) {
                inputSec.classList.add('opacity-50', 'pointer-events-none');
                inputEl.value = '';
                if(student.payments.remaining > 0 && instLeft <= 0) {
                    showToast("Maksimal cicilan (4x) telah tercapai, tapi belum lunas!", "error");
                }
            } else {
                inputSec.classList.remove('opacity-50', 'pointer-events-none');
                inputEl.value = student.payments.remaining;
            }

            document.getElementById('modal-payment').classList.remove('hidden');
        }

        function processPayment() {
            const amount = parseInt(document.getElementById('pay-amount-input').value);
            if(!amount || amount <= 0) { showToast("Masukkan nominal yang valid", "error"); return; }

            let students = DB.getStudents();
            let idx = students.findIndex(s => s.id === currentStudentForPayment);
            let student = students[idx];

            if(amount > student.payments.remaining) {
                showToast("Nominal melebihi sisa tagihan!", "error"); return;
            }

            student.payments.remaining -= amount;
            const installmentNum = student.payments.history.length + 1;
            
            student.payments.history.push({
                date: new Date().toISOString(),
                amount: amount,
                installmentNum: installmentNum
            });

            if(student.payments.remaining <= 0) {
                student.payments.status = 'LUNAS';
            }

            DB.saveStudents(students);
            addLog(`Mencatat pembayaran Rp${amount.toLocaleString('id-ID')} untuk pendaftar [${student.id}] ${student.name}`);
            
            showToast(`Pembayaran ke-${installmentNum} berhasil disimpan!`);
            
            renderAdminTable();
            openPaymentModal(student.id);
            setTimeout(() => { printReceipt(student.id, installmentNum - 1); }, 500);
        }

        // ================= PDF & QR CODE GENERATION =================
        function generateQRBase64(text) {
            let qr = qrcode(0, 'L');
            qr.addData(text);
            qr.make();
            return qr.createDataURL(4, 10);
        }

        // 1. Cetak Bukti Pendaftaran 
        function generateRegistrationPDF(studentId = null) {
            const id = typeof studentId === 'string' ? studentId : window.lastRegisteredId;
            const student = DB.getStudents().find(s => s.id === id);
            const settings = DB.getSettings();
            if(!student) return showToast("Data pendaftar tidak ditemukan", "error");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(`PANITIA PENERIMAAN SISWA BARU`, 105, 18, { align: "center" });
            doc.setFontSize(22);
            doc.text(settings.schoolName.toUpperCase(), 105, 28, { align: "center" });
            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.text(`TAHUN AJARAN ${settings.academicYear}`, 105, 36, { align: "center" });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("BUKTI REGISTRASI ONLINE", 105, 55, { align: "center" });
            doc.setLineWidth(0.5);
            doc.line(65, 57, 145, 57);

            doc.setFontSize(11);
            // Render basic data
            doc.setFont("helvetica", "bold"); doc.text("Nomor Pendaftaran :", 20, 70); doc.setFont("helvetica", "normal"); doc.text(student.id, 65, 70);
            doc.setFont("helvetica", "bold"); doc.text("Jalur Pendaftaran :", 20, 78); doc.setFont("helvetica", "normal"); doc.text((student.path || 'Reguler').toUpperCase(), 65, 78);
            doc.setFont("helvetica", "bold"); doc.text("Nama Lengkap :", 20, 86); doc.setFont("helvetica", "normal"); doc.text(student.name, 65, 86);
            doc.setFont("helvetica", "bold"); doc.text("Jenis Kelamin :", 20, 94); doc.setFont("helvetica", "normal"); doc.text(student.gender || '-', 65, 94);
            doc.setFont("helvetica", "bold"); doc.text("Agama :", 20, 102); doc.setFont("helvetica", "normal"); doc.text(student.religion || '-', 65, 102);
            doc.setFont("helvetica", "bold"); doc.text("NISN :", 20, 110); doc.setFont("helvetica", "normal"); doc.text(student.nisn, 65, 110);
            doc.setFont("helvetica", "bold"); doc.text("No. Handphone :", 20, 118); doc.setFont("helvetica", "normal"); doc.text(student.phone, 65, 118);
            
            // Render multiline text efficiently
            doc.setFont("helvetica", "bold"); doc.text("Alamat Domisili :", 20, 126); 
            doc.setFont("helvetica", "normal"); const domAddress = doc.splitTextToSize(student.address || '-', 80); doc.text(domAddress, 65, 126);
            
            let offsetAfterAddress = 126 + (domAddress.length * 5); 
            
            doc.setFont("helvetica", "bold"); doc.text("Asal Sekolah :", 20, offsetAfterAddress); 
            doc.setFont("helvetica", "normal"); doc.text(student.school, 65, offsetAfterAddress);

            doc.setFont("helvetica", "bold"); doc.text("Alamat SMP :", 20, offsetAfterAddress + 8); 
            doc.setFont("helvetica", "normal"); const schAddress = doc.splitTextToSize(student.schoolAddress || '-', 80); doc.text(schAddress, 65, offsetAfterAddress + 8);
            
            let offsetAfterSchAddr = offsetAfterAddress + 8 + (schAddress.length * 5);

            if(student.path === 'Prestasi' && student.achievementInfo) {
                doc.setFont("helvetica", "bold");
                doc.text("Data Prestasi :", 20, offsetAfterSchAddr); 
                doc.setFont("helvetica", "italic"); 
                const splitAch = doc.splitTextToSize(student.achievementInfo, 80);
                doc.text(splitAch, 65, offsetAfterSchAddr);
                offsetAfterSchAddr += (splitAch.length * 5);
            }

            if(student.notes) {
                doc.setFont("helvetica", "bold");
                doc.text("Catatan Panitia :", 20, offsetAfterSchAddr); 
                doc.setFont("helvetica", "italic"); 
                const splitNotes = doc.splitTextToSize(student.notes, 80);
                doc.text(splitNotes, 65, offsetAfterSchAddr);
            }

            // Photo profile (Top Right)
            if(student.photo) {
                try {
                    doc.addImage(student.photo, 'JPEG', 155, 70, 35, 45); 
                    doc.setLineWidth(0.2);
                    doc.rect(155, 70, 35, 45);
                } catch(e) { console.log("Failed adding photo to PDF", e); }
            }

            doc.setFont("helvetica", "bold");
            doc.text("Checklist Dokumen Daftar Ulang (Dibawa saat verifikasi fisik):", 20, 175);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            
            doc.setDrawColor(0);
            let checkListItems = [...settings.documents];
            if(student.path === 'Afirmasi') checkListItems.unshift("Surat Keterangan Tidak Mampu (SKTM) / KIP / PKH");
            
            checkListItems.forEach((docName, i) => {
                let y = 183 + (i * 8);
                doc.rect(25, y - 3, 4, 4);
                doc.text(docName, 32, y);
            });

            const qrText = `REG:${student.id}|NAMA:${student.name}|SEKOLAH:${settings.schoolName}|STATUS:VERIFIED`;
            const qrBase64 = generateQRBase64(qrText);
            doc.addImage(qrBase64, 'GIF', 20, 240, 35, 35);
            
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("KODE VERIFIKASI DIGITAL", 60, 255);
            doc.setFont("helvetica", "normal");
            doc.text("Dokumen ini sah dan diterbitkan secara elektronik oleh sistem PPDB.", 60, 260);
            doc.text("Pindai QR Code di samping untuk keperluan verifikasi oleh petugas.", 60, 264);
            
            doc.setFontSize(10);
            doc.text("Panitia Pendaftaran,", 150, 245);
            doc.text("_______________________", 145, 270);

            doc.save(`Bukti_Registrasi_${student.id}.pdf`);
            showToast("Dokumen berhasil diunduh.");
        }

        // 2. Cetak Kwitansi Pembayaran
        function printReceipt(studentId, historyIndex) {
            const student = DB.getStudents().find(s => s.id === studentId);
            if(!student) return;
            const payment = student.payments.history[historyIndex];
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a5', orientation: 'landscape' });
            
            doc.setDrawColor(0); doc.setLineWidth(0.5);
            doc.rect(10, 10, 190, 128);
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.setTextColor(37, 99, 235);
            doc.text("KWITANSI PEMBAYARAN", 105, 25, { align: "center" });
            
            doc.setDrawColor(200);
            doc.line(10, 32, 200, 32);

            doc.setTextColor(0);
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.text("No. Pendaftaran :", 20, 45); doc.setFont("helvetica", "normal"); doc.text(student.id, 65, 45);
            doc.setFont("helvetica", "bold");
            doc.text("Telah Terima Dari :", 20, 55); doc.setFont("helvetica", "normal"); doc.text(student.name, 65, 55);
            doc.setFont("helvetica", "bold");
            doc.text("Untuk Pembayaran :", 20, 65); doc.setFont("helvetica", "normal"); doc.text(`Cicilan Ke-${payment.installmentNum} Daftar Ulang PPDB`, 65, 65);
            
            doc.setFillColor(240, 240, 240);
            doc.rect(20, 75, 100, 15, 'F');
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text(formatRp(payment.amount), 25, 85);

            doc.setFontSize(10);
            doc.text(`Total Tagihan : ${formatRp(student.payments.totalFee)}`, 20, 100);
            doc.setTextColor(220, 38, 38);
            let sisaTeks = student.payments.status === 'LUNAS' ? 'LUNAS (Sisa Tagihan: Rp 0)' : `Sisa Tagihan: ${formatRp(student.payments.remaining)}`;
            doc.text(sisaTeks, 20, 107);
            
            doc.setTextColor(0);
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Tanggal Cetak: ${formatDate(new Date())}`, 140, 115);
            doc.text("Petugas,", 155, 125);

            let qrStatus = student.payments.status === 'LUNAS' ? 'LUNAS (Sisa Tagihan: Rp 0)' : `BELUM LUNAS. Sisa Tenor/Tagihan: ${formatRp(student.payments.remaining)}`;
            let qrText = `ID: ${student.id}\nNominal: ${formatRp(payment.amount)}\nStatus: ${qrStatus}`;
            
            const qrBase64 = generateQRBase64(qrText);
            doc.addImage(qrBase64, 'GIF', 150, 50, 35, 35);

            doc.save(`Kwitansi_${student.id}_Cicilan_${payment.installmentNum}.pdf`);
        }

        // Initialize App
        window.onload = () => {
            updateNetworkStatus();
            updateAppInfo();
            updateQuotaDisplay();
            
            if(DB.getStudents().length === 0) {
                const baseFee = DB.getSettings().baseFee || 1100000;
                DB.saveStudents([{
                    id: 'REG-2026-000', timestamp: new Date().toISOString(), path: 'Reguler', name: 'Budi Contoh', gender: 'Laki-laki', religion: 'Islam', nisn: '0011223344', school: 'SMPN 1', schoolAddress: 'Jl. Merdeka', phone: '08123456789', address: 'Jl. Sudirman', photo: '',
                    notes: '', admissionStatus: 'Menunggu',
                    payments: { totalFee: baseFee, remaining: baseFee, status: 'BELUM LUNAS', history: [] }
                }]);
            }
        };

    </script>

    <!-- Firebase Backend Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
        // Tambahkan Firestore SDK
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA0VRq2q3vobPGJdJ-iu0ZqhUxAjZ_lJVw",
            authDomain: "spmb2026-app.firebaseapp.com",
            projectId: "spmb2026-app",
            storageBucket: "spmb2026-app.firebasestorage.app",
            messagingSenderId: "131394467961",
            appId: "1:131394467961:web:5faa99dbaf1bc0daaafca8",
            measurementId: "G-XWCMWQSVN6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Fungsi Global untuk Push Data (Dari Local ke Firebase)
        window.firebaseSync = async function(key, data) {
            if (!navigator.onLine) return; // Batal jika sedang offline
            try {
                // Simpan data dalam satu dokumen sesuai 'key' (misal: dokumen 'ppdb_students')
                await setDoc(doc(db, "spmb_data", key), { payload: data });
                console.log(`[Firebase] Data '${key}' berhasil disinkronisasi ke cloud.`);
            } catch (error) {
                console.error("[Firebase] Gagal sinkronisasi:", error);
            }
        };

        // Fungsi Global untuk Pull Data (Dari Firebase ke Local saat aplikasi dimuat)
        window.firebasePull = async function() {
            if (!navigator.onLine) return;
            try {
                const keys = ['ppdb_students', 'ppdb_settings', 'ppdb_users', 'ppdb_logs'];
                let isUpdated = false;
                
                for (let key of keys) {
                    const snap = await getDoc(doc(db, "spmb_data", key));
                    if (snap.exists()) {
                        const cloudData = snap.data().payload;
                        const localData = localStorage.getItem(key);
                        
                        // Timpa lokal jika data cloud berbeda/baru
                        if (JSON.stringify(cloudData) !== localData) {
                            localStorage.setItem(key, JSON.stringify(cloudData));
                            isUpdated = true;
                        }
                    }
                }
                
                if (isUpdated) {
                    console.log("[Firebase] Data terbaru ditarik dari cloud.");
                    // Refresh UI agar data baru langsung muncul
                    if(typeof updateAppInfo === 'function') updateAppInfo();
                    if(typeof updateQuotaDisplay === 'function') updateQuotaDisplay();
                    if(typeof renderAdminTable === 'function' && document.getElementById('page-admin').classList.contains('active')) {
                        renderAdminTable();
                    }
                }
            } catch (error) {
                console.error("[Firebase] Gagal menarik data:", error);
            }
        };

        // Tarik data pertama kali saat halaman dimuat
        setTimeout(() => { window.firebasePull(); }, 1000); 
    </script>
</body>
</html>
